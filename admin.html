<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Nyhetsportalen</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-container {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            margin-bottom: 2rem;
        }

        .logo h1 {
            color: #2563eb;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .logo p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .login-btn {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: 1rem;
            display: none;
        }

        .admin-panel {
            display: none;
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .admin-title {
            color: #1e293b;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #374151;
        }

        .action-btn:hover {
            border-color: #2563eb;
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .action-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .action-desc {
            font-size: 0.9rem;
            color: #64748b;
        }

        .procurement-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #e5e7eb;
        }

        .procurement-section h2 {
            color: #1e293b;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .procurement-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .proc-btn {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .proc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3);
        }

        .status-message {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            color: #0c4a6e;
            display: none;
        }

        .status-message.success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #166534;
        }

        .status-message.error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .data-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .data-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .data-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .anomalies-list, .procurements-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .anomaly-item {
            background: white;
            border-left: 4px solid #ef4444;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
        }

        .anomaly-company {
            font-weight: 600;
            color: #1e293b;
        }

        .anomaly-score {
            background: #ef4444;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .anomaly-details {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .procurement-item {
            background: white;
            border-left: 4px solid #2563eb;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
        }

        .procurement-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .procurement-meta {
            font-size: 0.9rem;
            color: #64748b;
        }

        .procurement-value {
            background: #2563eb;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        /* Company Intelligence Styles */
        .company-intelligence-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #e5e7eb;
        }

        .company-intelligence-section h2 {
            color: #1e293b;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .search-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .search-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .search-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .search-group label {
            font-weight: 600;
            color: #374151;
        }

        .search-group input {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .search-group input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .search-btn, .analysis-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .search-btn:hover, .analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .analysis-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .intelligence-results {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
        }

        .results-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .results-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .search-results, .risk-companies, .network-connections {
            max-height: 400px;
            overflow-y: auto;
        }

        .company-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .company-item:hover {
            border-color: #6366f1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }

        .company-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .company-meta {
            font-size: 0.9rem;
            color: #64748b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .risk-score {
            background: #ef4444;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .risk-score.medium {
            background: #f59e0b;
        }

        .risk-score.low {
            background: #10b981;
        }

        .person-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .person-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .person-roles {
            font-size: 0.9rem;
            color: #64748b;
        }

        .connection-item {
            background: white;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .connection-type {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .connection-details {
            font-size: 0.9rem;
            color: #64748b;
        }

        .company-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Political Monitoring Styles */
        .political-monitoring-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #e5e7eb;
        }

        .political-monitoring-section h2 {
            color: #1e293b;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .political-search-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .political-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .conflict-results, .cross-ref-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .conflict-item {
            background: white;
            border-left: 4px solid #dc2626;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .conflict-type {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 0.5rem;
        }

        .conflict-details {
            font-size: 0.9rem;
            color: #64748b;
        }

        .politician-item {
            background: white;
            border-left: 4px solid #2563eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .politician-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .politician-info {
            font-size: 0.9rem;
            color: #64748b;
        }

        .decision-item {
            background: white;
            border-left: 4px solid #059669;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .decision-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .decision-details {
            font-size: 0.9rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>🔐 Admin Panel</h1>
            <p>Nyhetsportalen</p>
        </div>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="username">Användarnamn</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Lösenord</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" class="login-btn">Logga in</button>
            <div class="error-message" id="errorMessage">
                Fel användarnamn eller lösenord!
            </div>
        </form>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h1 class="admin-title">Admin Dashboard</h1>
            <button class="logout-btn" onclick="logout()">Logga ut</button>
        </div>

        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalProcurements">16</div>
                <div class="stat-label">Upphandlingar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCompanies">0</div>
                <div class="stat-label">Företag</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPoliticians">0</div>
                <div class="stat-label">Politiker</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalConflicts">0</div>
                <div class="stat-label">Konflikter</div>
            </div>
        </div>

        <div class="procurement-section">
            <h2>🕵️ Upphandlingsövervakning</h2>
            <div class="procurement-controls">
                <button class="proc-btn" onclick="updateProcurementData()">🔄 Uppdatera Data</button>
                <button class="proc-btn" onclick="runAnalysis()">📊 Kör Analys</button>
                <button class="proc-btn" onclick="runFullCycle()">⚡ Fullständig Scan</button>
                <button class="proc-btn" onclick="viewDashboard()">📈 Visa Dashboard</button>
            </div>
            
            <div class="status-message" id="statusMessage"></div>
            
            <div class="data-sections">
                <div class="data-section">
                    <h3>🚨 Senaste Anomalier</h3>
                    <div id="anomaliesList" class="anomalies-list">
                        <p>Laddar anomalier...</p>
                    </div>
                </div>
                
                <div class="data-section">
                    <h3>📋 Senaste Upphandlingar</h3>
                    <div id="procurementsList" class="procurements-list">
                        <p>Laddar upphandlingar...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="company-intelligence-section">
            <h2>🏢 Företagsintelligens & Ägaranalys</h2>
            
            <div class="search-section">
                <div class="search-controls">
                    <div class="search-group">
                        <label>Sök Företag:</label>
                        <input type="text" id="companySearch" placeholder="Företagsnamn eller org.nr" />
                        <button class="search-btn" onclick="searchCompanies()">🔍 Sök</button>
                    </div>
                    <div class="search-group">
                        <label>Sök Person:</label>
                        <input type="text" id="personSearch" placeholder="Namn eller personnummer" />
                        <button class="search-btn" onclick="searchPeople()">👤 Sök</button>
                    </div>
                </div>
                
                <div class="analysis-controls">
                    <button class="analysis-btn" onclick="analyzeRisks()">⚠️ Riskanalys</button>
                    <button class="analysis-btn" onclick="analyzeNetworks()">🌐 Nätverksanalys</button>
                    <button class="analysis-btn" onclick="analyzeCompetitors()">🔄 Konkurrentanalys</button>
                </div>
            </div>

            <div class="intelligence-results">
                <div class="results-section">
                    <h3>🔍 Sökresultat</h3>
                    <div id="searchResults" class="search-results">
                        <p>Använd sökfunktionerna ovan för att analysera företag och personer.</p>
                    </div>
                </div>
                
                <div class="results-section">
                    <h3>⚠️ Högrisk Företag</h3>
                    <div id="riskCompanies" class="risk-companies">
                        <p>Laddar riskanalys...</p>
                    </div>
                </div>
                
                <div class="results-section">
                    <h3>🌐 Misstänkta Kopplingar</h3>
                    <div id="networkConnections" class="network-connections">
                        <p>Kör nätverksanalys för att se kopplingar.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="political-monitoring-section">
            <h2>🏛️ Politisk Övervakning</h2>
            
            <div class="political-search-section">
                <div class="search-controls">
                    <div class="search-group">
                        <label>Sök Politiker:</label>
                        <input type="text" id="politicianSearch" placeholder="Namn eller parti" />
                        <button class="search-btn" onclick="searchPoliticians()">👤 Sök</button>
                    </div>
                    <div class="search-group">
                        <label>Sök Beslut:</label>
                        <input type="text" id="decisionSearch" placeholder="Beslut eller ärende" />
                        <button class="search-btn" onclick="searchDecisions()">📝 Sök</button>
                    </div>
                </div>
                
                <div class="analysis-controls">
                    <button class="analysis-btn" onclick="analyzeConflicts()">⚠️ Konfliktanalys</button>
                    <button class="analysis-btn" onclick="analyzeAttendance()">📊 Närvaroanalys</button>
                    <button class="analysis-btn" onclick="crossReferenceData()">🔄 Korsreferens</button>
                </div>
            </div>

            <div class="political-results">
                <div class="results-section">
                    <h3>🔍 Politiska Sökresultat</h3>
                    <div id="politicalSearchResults" class="search-results">
                        <p>Använd sökfunktionerna ovan för att analysera politiker och beslut.</p>
                    </div>
                </div>
                
                <div class="results-section">
                    <h3>⚠️ Intressekonflikter</h3>
                    <div id="conflictResults" class="conflict-results">
                        <p>Kör konfliktanalys för att upptäcka potentiella intressekonflikter.</p>
                    </div>
                </div>
                
                <div class="results-section">
                    <h3>🔄 Korsreferenser</h3>
                    <div id="crossRefResults" class="cross-ref-results">
                        <p>Visa kopplingar mellan politik, upphandling och företag.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-actions">
            <a href="index.html" class="action-btn">
                <div class="action-icon">🏠</div>
                <div class="action-title">Visa Hemsida</div>
                <div class="action-desc">Gå till den publika nyhetsportalen</div>
            </a>
            <div class="action-btn" onclick="editArticles()">
                <div class="action-icon">📝</div>
                <div class="action-title">Redigera Artiklar</div>
                <div class="action-desc">Lägg till, redigera eller ta bort nyheter</div>
            </div>
            <div class="action-btn" onclick="viewStats()">
                <div class="action-icon">📊</div>
                <div class="action-title">Statistik</div>
                <div class="action-desc">Visa besöksstatistik och analytics</div>
            </div>
            <div class="action-btn" onclick="manageSettings()">
                <div class="action-icon">⚙️</div>
                <div class="action-title">Inställningar</div>
                <div class="action-desc">Hantera sidinställningar och konfiguration</div>
            </div>
            <div class="action-btn" onclick="backup()">
                <div class="action-icon">💾</div>
                <div class="action-title">Backup</div>
                <div class="action-desc">Säkerhetskopiera och återställ data</div>
            </div>
            <div class="action-btn" onclick="security()">
                <div class="action-icon">🛡️</div>
                <div class="action-title">Säkerhet</div>
                <div class="action-desc">Hantera säkerhetsinställningar</div>
            </div>
        </div>
    </div>

    <!-- Modal container -->
    <div id="modalContainer"></div>

    <script src="production-api.js"></script>
    <script>
        // Simple authentication (för demo - i produktion använd riktig autentisering)
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'nyheter2025'
        };

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                // Framgångsrik inloggning
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                // Spara session
                sessionStorage.setItem('adminLoggedIn', 'true');
            } else {
                // Visa felmeddelande
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        // Kontrollera om användaren redan är inloggad
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDashboardData(); // Ladda dashboard-data vid inloggning
        }

        // Procurement Monitor Functions
        async function updateProcurementData() {
            showStatus('Startar datauppdatering...', 'info');
            
            try {
                const result = await window.procurementAPI.updateData();
                
                if (result.success) {
                    showStatus('Datauppdatering klar! Nya upphandlingar har lagts till.', 'success');
                    loadDashboardData();
                } else {
                    showStatus('Fel vid datauppdatering', 'error');
                }
            } catch (error) {
                showStatus('Fel vid datauppdatering: ' + error.message, 'error');
            }
        }

        async function runAnalysis() {
            showStatus('Startar analys av upphandlingsdata...', 'info');
            
            try {
                const result = await window.procurementAPI.runAnalysis();
                
                if (result.success) {
                    showStatus('Analys klar! Nya anomalier har upptäckts.', 'success');
                    loadDashboardData();
                } else {
                    showStatus('Fel vid analys', 'error');
                }
            } catch (error) {
                showStatus('Fel vid analys: ' + error.message, 'error');
            }
        }

        async function runFullCycle() {
            showStatus('Startar fullständig scan (datainsamling + analys)...', 'info');
            
            try {
                const result = await window.procurementAPI.runFullCycle();
                
                if (result.success) {
                    showStatus('Fullständig scan klar! Data och anomalier uppdaterade.', 'success');
                    loadDashboardData();
                } else {
                    showStatus('Fel vid fullständig scan', 'error');
                }
            } catch (error) {
                showStatus('Fel vid fullständig scan: ' + error.message, 'error');
            }
        }

        function viewDashboard() {
            loadDashboardData();
            showStatus('Dashboard uppdaterat!', 'success');
        }

        function loadDashboardData() {
            try {
                const data = window.procurementAPI.getDashboardData();
                const companyStats = window.companyIntelligenceAPI.getDashboardStats();
                
                // Uppdatera statistik
                if (data.stats) {
                    document.getElementById('totalProcurements').textContent = data.stats.total_procurements || '0';
                    document.getElementById('totalAnomalies').textContent = data.stats.total_anomalies || '0';
                }
                
                if (companyStats) {
                    document.getElementById('totalCompanies').textContent = companyStats.totalCompanies || '0';
                    document.getElementById('highRiskCompanies').textContent = companyStats.highRiskCompanies || '0';
                }
                
                // Uppdatera anomalier
                displayAnomalies(data.anomalies || []);
                
                // Uppdatera upphandlingar
                displayProcurements(data.procurements || []);
                
                // Ladda riskföretag
                loadRiskCompanies();
                
                // Ladda politisk övervakning
                updatePoliticalStats();
                
            } catch (error) {
                showStatus('Fel vid laddning av dashboard: ' + error.message, 'error');
            }
        }

        // Company Intelligence Functions
        function searchCompanies() {
            const query = document.getElementById('companySearch').value;
            if (!query.trim()) {
                showStatus('Ange ett sökord för företag', 'error');
                return;
            }
            
            const results = window.companyIntelligenceAPI.searchCompany(query);
            displaySearchResults(results, 'company');
            showStatus(`Hittade ${results.length} företag`, 'success');
        }

        function searchPeople() {
            const query = document.getElementById('personSearch').value;
            if (!query.trim()) {
                showStatus('Ange ett sökord för person', 'error');
                return;
            }
            
            const results = window.companyIntelligenceAPI.searchPerson(query);
            displaySearchResults(results, 'person');
            showStatus(`Hittade ${results.length} personer`, 'success');
        }

        function analyzeRisks() {
            const riskAnalysis = window.companyIntelligenceAPI.getRiskAnalysis();
            displayRiskAnalysis(riskAnalysis);
            showStatus('Riskanalys klar!', 'success');
        }

        function analyzeNetworks() {
            // Visa nätverkskopplingar för de mest misstänkta företagen
            const riskAnalysis = window.companyIntelligenceAPI.getRiskAnalysis();
            const topCompanies = riskAnalysis.highRiskCompanies.slice(0, 3);
            
            let allConnections = [];
            topCompanies.forEach(company => {
                const connections = window.companyIntelligenceAPI.findNetworkConnections(company.orgNr);
                allConnections = allConnections.concat(connections);
            });
            
            displayNetworkConnections(allConnections);
            showStatus(`Hittade ${allConnections.length} misstänkta kopplingar`, 'success');
        }

        function analyzeCompetitors() {
            const municipality = 'Stockholm'; // Default
            const analysis = window.companyIntelligenceAPI.analyzeCompetitorBidding(municipality);
            displayCompetitorAnalysis(analysis);
            showStatus(`Analyserade konkurrentmönster för ${municipality}`, 'success');
        }

        function displaySearchResults(results, type) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p>Inga resultat hittades.</p>';
                return;
            }
            
            let html = '';
            
            if (type === 'company') {
                html = results.map(company => `
                    <div class="company-item" onclick="showCompanyDetails('${company.orgNr}')">
                        <div class="company-name">${company.name}</div>
                        <div class="company-meta">
                            <span>${company.orgNr}</span>
                            <span class="risk-score ${getRiskLevel(company.riskScore)}">${company.riskScore.toFixed(1)}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                            ${company.businessArea} • ${company.employees} anställda
                        </div>
                    </div>
                `).join('');
            } else if (type === 'person') {
                html = results.map(person => `
                    <div class="person-item">
                        <div class="person-name">${person.name}</div>
                        <div class="person-roles">
                            ${person.roles.slice(0, 3).join(', ')}
                            ${person.roles.length > 3 ? '...' : ''}
                        </div>
                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                            ${person.companies.length} företagskopplingar
                        </div>
                    </div>
                `).join('');
            }
            
            container.innerHTML = html;
        }

        function displayRiskAnalysis(analysis) {
            loadRiskCompanies(); // Uppdatera riskföretag-sektionen
            
            // Visa detaljerad statistik i searchResults
            const container = document.getElementById('searchResults');
            container.innerHTML = `
                <div style="background: white; padding: 1rem; border-radius: 8px;">
                    <h4>📊 Riskstatistik</h4>
                    <div style="margin-top: 1rem;">
                        <div>🟢 Låg risk: ${analysis.riskStatistics.low} företag</div>
                        <div>🟡 Medium risk: ${analysis.riskStatistics.medium} företag</div>
                        <div>🔴 Hög risk: ${analysis.riskStatistics.high} företag</div>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.9rem; color: #64748b;">
                        Totalt analyserade: ${analysis.totalAnalyzedCompanies} företag
                    </div>
                </div>
            `;
        }

        function loadRiskCompanies() {
            const riskAnalysis = window.companyIntelligenceAPI.getRiskAnalysis();
            const container = document.getElementById('riskCompanies');
            
            if (riskAnalysis.highRiskCompanies.length === 0) {
                container.innerHTML = '<p>Inga högriskföretag identifierade.</p>';
                return;
            }
            
            const html = riskAnalysis.highRiskCompanies.slice(0, 10).map(company => `
                <div class="company-item" onclick="showCompanyDetails('${company.orgNr}')">
                    <div class="company-name">${company.name}</div>
                    <div class="company-meta">
                        <span>${company.businessArea}</span>
                        <span class="risk-score">${company.riskScore.toFixed(1)}</span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function displayNetworkConnections(connections) {
            const container = document.getElementById('networkConnections');
            
            if (connections.length === 0) {
                container.innerHTML = '<p>Inga misstänkta kopplingar hittades.</p>';
                return;
            }
            
            const html = connections.slice(0, 10).map(conn => `
                <div class="connection-item">
                    <div class="connection-type">${conn.connectionType}</div>
                    <div class="connection-details">
                        ${conn.company.name}<br>
                        <small>${conn.sharedPeople.length} gemensamma personer</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function displayCompetitorAnalysis(analysis) {
            const container = document.getElementById('networkConnections');
            
            if (analysis.length === 0) {
                container.innerHTML = '<p>Inga misstänkta konkurrensmönster hittades.</p>';
                return;
            }
            
            const html = analysis.map(item => `
                <div class="connection-item">
                    <div class="connection-type">Misstänkt konkurrensmönster</div>
                    <div class="connection-details">
                        ${item.company.name}<br>
                        <small>Risknivå: ${item.riskLevel} • ${item.suspiciousConnections.length} kopplingar</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function showCompanyDetails(orgNr) {
            const company = window.companyIntelligenceAPI.getCompanyDetails(orgNr);
            if (!company) return;
            
            // Skapa modal med företagsdetaljer
            const modalHtml = `
                <div class="company-details-modal" id="companyModal">
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeCompanyModal()">×</button>
                        <h2>${company.name}</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                            <div>
                                <h3>Grunduppgifter</h3>
                                <p><strong>Org.nr:</strong> ${company.orgNr}</p>
                                <p><strong>Verksamhetsområde:</strong> ${company.businessArea}</p>
                                <p><strong>Anställda:</strong> ${company.employees}</p>
                                <p><strong>Omsättning:</strong> ${window.companyIntelligence.formatCurrency(company.revenue)}</p>
                                <p><strong>Riskpoäng:</strong> <span class="risk-score">${company.riskScore.toFixed(1)}</span></p>
                            </div>
                            <div>
                                <h3>Ägare</h3>
                                ${company.owners.map(owner => `
                                    <p>${owner.person.name} (${owner.ownership.toFixed(1)}%)</p>
                                `).join('')}
                            </div>
                        </div>
                        <div style="margin-top: 2rem;">
                            <h3>Styrelse</h3>
                            ${company.boardMembers.map(member => `
                                <p>${member.person.name} - ${member.role}</p>
                            `).join('')}
                        </div>
                        ${company.contracts.length > 0 ? `
                            <div style="margin-top: 2rem;">
                                <h3>Senaste Kontrakt (${company.contracts.length})</h3>
                                ${company.contracts.slice(0, 5).map(contract => `
                                    <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                                        ${contract.title} - ${window.companyIntelligence.formatCurrency(contract.value)}
                                    </p>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Ta bort befintlig modal
            const existingModal = document.getElementById('companyModal');
            if (existingModal) existingModal.remove();
            
            // Lägg till ny modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('companyModal').style.display = 'block';
        }

        function closeCompanyModal() {
            const modal = document.getElementById('companyModal');
            if (modal) modal.remove();
        }

        function getRiskLevel(score) {
            if (score <= 3) return 'low';
            if (score <= 6) return 'medium';
            return 'high';
        }

        function displayAnomalies(anomalies) {
            const container = document.getElementById('anomaliesList');
            
            if (anomalies.length === 0) {
                container.innerHTML = '<p>Inga anomalier hittade.</p>';
                return;
            }
            
            const html = anomalies.slice(0, 10).map(anomaly => `
                <div class="anomaly-item">
                    <div class="anomaly-company">
                        ${anomaly.company_name}
                        <span class="anomaly-score">${anomaly.score.toFixed(1)}</span>
                    </div>
                    <div class="anomaly-details">
                        <strong>${anomaly.anomaly_type}</strong> - ${anomaly.municipality}<br>
                        ${anomaly.details}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function displayProcurements(procurements) {
            const container = document.getElementById('procurementsList');
            
            if (procurements.length === 0) {
                container.innerHTML = '<p>Inga upphandlingar hittade.</p>';
                return;
            }
            
            const html = procurements.slice(0, 10).map(proc => `
                <div class="procurement-item">
                    <div class="procurement-title">${proc.title}</div>
                    <div class="procurement-meta">
                        ${proc.municipality} - ${proc.winner_company}
                        <span class="procurement-value">${formatValue(proc.value)} kr</span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function formatValue(value) {
            return new Intl.NumberFormat('sv-SE').format(Math.round(value));
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            // Dölj meddelandet efter 5 sekunder
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function editArticles() {
            alert('Artikelredigerare kommer snart! 📝');
        }

        function viewStats() {
            alert('Statistik-dashboard kommer snart! 📊');
        }

        function manageSettings() {
            alert('Inställningspanel kommer snart! ⚙️');
        }

        function backup() {
            alert('Backup-funktionalitet kommer snart! 💾');
        }

        function security() {
            alert('Säkerhetsinställningar kommer snart! 🛡️');
        }

        // Political Monitoring Functions
        function searchPoliticians() {
            const query = document.getElementById('politicianSearch').value.trim();
            if (!query) {
                alert('Vänligen ange ett sökord för politiker');
                return;
            }
            
            try {
                const results = window.politicalAPI.searchPoliticians(query);
                displayPoliticalSearchResults(results, 'politicians');
            } catch (error) {
                console.error('Fel vid sökning av politiker:', error);
                alert('Fel vid sökning av politiker');
            }
        }

        function searchDecisions() {
            const query = document.getElementById('decisionSearch').value.trim();
            if (!query) {
                alert('Vänligen ange ett sökord för beslut');
                return;
            }
            
            try {
                const results = window.politicalAPI.searchDecisions(query);
                displayPoliticalSearchResults(results, 'decisions');
            } catch (error) {
                console.error('Fel vid sökning av beslut:', error);
                alert('Fel vid sökning av beslut');
            }
        }

        function analyzeConflicts() {
            try {
                const conflicts = window.politicalAPI.detectConflicts();
                displayConflictResults(conflicts);
            } catch (error) {
                console.error('Fel vid konfliktanalys:', error);
                alert('Fel vid konfliktanalys');
            }
        }

        function analyzeAttendance() {
            try {
                const analysis = window.politicalAPI.analyzeAttendance();
                displayAttendanceResults(analysis);
            } catch (error) {
                console.error('Fel vid närvaroanalys:', error);
                alert('Fel vid närvaroanalys');
            }
        }

        function crossReferenceData() {
            try {
                const crossRefs = window.politicalAPI.crossReference();
                displayCrossRefResults(crossRefs);
            } catch (error) {
                console.error('Fel vid korsreferens:', error);
                alert('Fel vid korsreferens');
            }
        }

        function displayPoliticalSearchResults(results, type) {
            const container = document.getElementById('politicalSearchResults');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<p>Inga resultat hittades för din sökning.</p>';
                return;
            }
            
            let html = '';
            
            if (type === 'politicians') {
                html = results.map(politician => `
                    <div class="politician-item">
                        <div class="politician-name">${politician.name}</div>
                        <div class="politician-info">
                            ${politician.party} | ${politician.municipality}<br>
                            ${politician.position} | Närvaro: ${politician.attendanceRate.toFixed(1)}%
                        </div>
                    </div>
                `).join('');
            } else if (type === 'decisions') {
                html = results.map(decision => `
                    <div class="decision-item">
                        <div class="decision-title">${decision.title}</div>
                        <div class="decision-details">
                            ${decision.municipality} | ${decision.date}<br>
                            Typ: ${decision.type} | Status: ${decision.outcome}
                        </div>
                    </div>
                `).join('');
            }
            
            container.innerHTML = html;
        }

        function displayConflictResults(conflicts) {
            const container = document.getElementById('conflictResults');
            
            if (!conflicts || conflicts.length === 0) {
                container.innerHTML = '<p>Inga intressekonflikter upptäckta.</p>';
                return;
            }
            
            const html = conflicts.map(conflict => `
                <div class="conflict-item">
                    <div class="conflict-type">${conflict.type}</div>
                    <div class="conflict-details">
                        <strong>${conflict.politician}</strong><br>
                        ${conflict.description}<br>
                        <small>Risknivå: ${conflict.severity}</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function displayAttendanceResults(analysis) {
            const container = document.getElementById('politicalSearchResults');
            
            if (!analysis || analysis.length === 0) {
                container.innerHTML = '<p>Ingen närvarodata tillgänglig.</p>';
                return;
            }
            
            const html = analysis.map(item => `
                <div class="politician-item">
                    <div class="politician-name">${item.politician}</div>
                    <div class="politician-info">
                        Närvaro: ${item.attendanceRate.toFixed(1)}% | Trend: ${item.trend}<br>
                        <small>${item.analysis}</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function displayCrossRefResults(crossRefs) {
            const container = document.getElementById('crossRefResults');
            
            if (!crossRefs || crossRefs.length === 0) {
                container.innerHTML = '<p>Inga korsreferenser hittades.</p>';
                return;
            }
            
            const html = crossRefs.map(ref => `
                <div class="connection-item">
                    <div class="connection-type">${ref.type}</div>
                    <div class="connection-details">
                        <strong>${ref.politician}</strong> ↔ <strong>${ref.entity}</strong><br>
                        ${ref.description}<br>
                        <small>Upptäckt: ${ref.discoveryDate}</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function updatePoliticalStats() {
            try {
                const stats = window.politicalAPI.getStats();
                document.getElementById('totalPoliticians').textContent = stats.totalPoliticians;
                document.getElementById('totalConflicts').textContent = stats.totalConflicts;
            } catch (error) {
                console.error('Fel vid uppdatering av politisk statistik:', error);
            }
        }

        // Förhindra tillgång via direktlänk
        window.onload = function() {
            if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        };
    </script>
</body>
</html>
